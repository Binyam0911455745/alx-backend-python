#!/bin/bash

echo "Starting Blue-Green deployment..."

# Deploy the new "green" version
kubectl apply -f green_deployment.yaml
echo "Green deployment initiated."

# Wait for the green deployment to be ready
kubectl rollout status deployment/messaging-app-deployment-green --timeout=300s
if [ $? -ne 0 ]; then
    echo "Green deployment failed to become ready. Exiting."
    exit 1
fi

echo "Green deployment is ready. Switching traffic."

# Switch the service to point to the green deployment
kubectl apply -f kubeservice.yaml
echo "Service updated. Traffic is now routed to the green version."

# Optional: Check logs of the new pod for any errors
GREEN_POD=$(kubectl get pods -l app=messaging-app,version=green -o jsonpath='{.items[0].metadata.name}')
echo "Checking logs for the new green pod: $GREEN_POD"
kubectl logs $GREEN_POD
